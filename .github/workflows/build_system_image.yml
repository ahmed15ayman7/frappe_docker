name: build system Image base on json config provided
# run-name: ${{ github.actor }} update ðŸš€


on:
#   workflow_dispatch:
  pull_request:
    types: [opened, reopened]
    branches: [master]

# on:
#   workflow_run:
#     workflows: ["Master Workflow"]
#     types:
#       - completed

   
jobs:
  job-image-build:
    runs-on:
     - self-hosted
   

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2
        
      - name: login to harb
        uses: docker/login-action@v1
        with:
          registry: harbor.fintechsys.net
          username: ${{ secrets.PHEE_HARBOR_USERNAME  }}
          password: ${{ secrets.PHEE_HARBOR_PASSWORD }}
      - name: Execute custom commands
        run: |
          git clone --recursive "https://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@github.com/fintechsys/remittance_image_builder.git"
          cd remittance_image_builder
          
          ../build_network_company_image.sh --tag="remittance_network_agent:version-14" --token="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" --frappe-path="https://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@github.com/fintechsys/frappe.git" --frappe-branch=version-14
          
          docker image ls
          docker tag remittance_network_agent:version-14 harbor.fintechsys.net/frappe-systems/devlop:version-14
          docker push harbor.fintechsys.net/frappe-systems/remittance_network_agent:version-14
       
      #Creat Bench and sites
      
      - name: Create first bench
        run: |
          echo 'The branch name is' $BRANCH_NAME
          cp example.env ~/gitopss/erpnext-one.env
          sed -i 's/DB_PASSWORD=123/DB_PASSWORD=fintech2023/g' ~/gitopss/erpnext-one.env
          sed -i 's/DB_HOST=/DB_HOST=mariadb-database/g' ~/gitopss/erpnext-one.env
          sed -i 's/DB_PORT=/DB_PORT=3306/g' ~/gitopss/erpnext-one.env
          sed -i 's/SITES=`erp.fintechsys.net`/SITES=\`agent.fintechsys.net\`/g' ~/gitopss/erpnext-one.env
          echo 'ROUTER=erpnext-one' >> ~/gitopss/erpnext-one.env
          echo "BENCH_NETWORK=erpnext-one" >> ~/gitopss/erpnext-one.env

      - name: Create a yaml file to deploy container
        run: |
          docker compose --project-name erpnext-one \
          --env-file ~/gitopss/erpnext-one.env \
          -f compose.yaml \
          -f overrides/compose.redis.yaml \
          -f overrides/compose.multi-bench.yaml \
          -f overrides/compose.multi-bench-ssl.yaml config > ~/gitopss/erpnext-one.yaml


      - name: Deploy the container
        run: |
          docker compose --project-name erpnext-one -f ~/gitopss/erpnext-one.yaml up -d 

      
      - name: Create the site
        run: | 
          docker compose --project-name erpnext-one exec -T backend \
            bench new-site --no-mariadb-socket --mariadb-root-password fintech2023 --install-app hrms --set-default \
                 --install-app rule_management --install-app remittance_base --install-app remittance --install-app bulk_remittance --install-app remittance_stellar_integration \
                 --install-app client_account_management  --install-app teller_for_erpnext --install-app teller_for_agent \
                 --install-app remittance_agent_service --install-app payment_management --install-app bank_services --install-app remittance_customize \
                 --install-app remittance_network_manager --install-app erpnext_theme --install-app remittance_website --admin-password fintech2023  agent.fintechsys.net
      
